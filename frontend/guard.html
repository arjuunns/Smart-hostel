<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guard Dashboard - Smart Hostel</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h2><img src="image.png" alt="Smart Hostel" class="logo"> Smart Hostel</h2>
            <div class="user-info">
                <div class="name">Guard</div>
                <div class="role">GUARD</div>
            </div>
            <nav>
                <a href="#" class="active" onclick="showSection('scan')">Scan Gate Pass</a>
                <a href="#" onclick="showSection('out-list')">Out Students</a>
                <a href="#" onclick="showSection('logs')">Gate Logs</a>
            </nav>
            <div class="theme-toggle" onclick="toggleTheme()">
                <svg class="theme-toggle-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
                <span>Toggle Theme</span>
            </div>
            <div class="logout-btn">
                <button class="btn btn-secondary" onclick="utils.logout()" style="width: 100%;">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Scan Section -->
            <section id="scan-section">
                <h1>Gate Pass Scanner</h1>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="outCount">0</div>
                        <div class="stat-label">Students Currently Out</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todayExits">0</div>
                        <div class="stat-label">Today's Exits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todayEntries">0</div>
                        <div class="stat-label">Today's Entries</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Manual Gate Pass Entry</h3>
                    <p style="color: var(--text-muted); margin-bottom: 16px;">Enter the Gate Pass ID shown on the student's QR code</p>
                    
                    <div class="manual-entry">
                        <div class="form-group">
                            <label for="gatePassInput">Gate Pass ID</label>
                            <input type="text" id="gatePassInput" placeholder="GP-XXXXX-XXXXX" 
                                   style="font-size: 18px; text-transform: uppercase;">
                        </div>
                        
                        <div class="action-buttons" style="justify-content: center; margin-top: 20px;">
                            <button class="btn btn-danger" onclick="processGatePass('exit')" style="padding: 16px 40px; font-size: 16px;">
                                EXIT
                            </button>
                            <button class="btn btn-success" onclick="processGatePass('entry')" style="padding: 16px 40px; font-size: 16px;">
                                ENTRY
                            </button>
                        </div>
                    </div>

                    <div id="scanResult" class="message" style="margin-top: 20px;"></div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <h3>Recent Activity</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Student</th>
                                    <th>Action</th>
                                    <th>Gate Pass</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityTable">
                                <tr><td colspan="4" class="empty-state">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Out Students Section -->
            <section id="out-list-section" class="hidden">
                <h1>Students Currently Out</h1>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <span id="outListCount">0</span> students currently out
                        </div>
                        <button class="btn btn-secondary" onclick="loadOutStudents()">Refresh</button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Hostel / Room</th>
                                    <th>Phone</th>
                                    <th>Left At</th>
                                    <th>Expected Return</th>
                                    <th>Status</th>
                                    <th>Gate Pass</th>
                                </tr>
                            </thead>
                            <tbody id="outStudentsTable">
                                <tr><td colspan="7" class="empty-state">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Overstayed Alert -->
                <div class="card" id="overstayedCard" style="display: none; border-left: 4px solid var(--danger-color);">
                    <h3>Overstayed Students</h3>
                    <p style="color: var(--text-muted); margin-bottom: 16px;">These students have exceeded their leave period</p>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Phone</th>
                                    <th>Expected Return</th>
                                    <th>Overdue By</th>
                                </tr>
                            </thead>
                            <tbody id="overstayedTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Gate Logs Section -->
            <section id="logs-section" class="hidden">
                <h1>Gate Logs</h1>
                
                <div class="card" style="margin-bottom: 20px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="logDate">Date</label>
                            <input type="date" id="logDate" onchange="loadGateLogs()">
                        </div>
                        <div class="form-group">
                            <label for="logAction">Action</label>
                            <select id="logAction" onchange="loadGateLogs()">
                                <option value="">All</option>
                                <option value="EXIT">Exit Only</option>
                                <option value="ENTRY">Entry Only</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Student</th>
                                    <th>Hostel / Room</th>
                                    <th>Action</th>
                                    <th>Gate Pass ID</th>
                                </tr>
                            </thead>
                            <tbody id="gateLogsTable">
                                <tr><td colspan="5" class="empty-state">Select a date to view logs</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        // Check authentication
        if (!utils.checkAuth()) {
            window.location.href = 'index.html';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initSidebar();
            loadDashboardStats();
            loadRecentActivity();
            
            // Set default date for logs
            document.getElementById('logDate').value = new Date().toISOString().split('T')[0];

            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadDashboardStats();
                loadRecentActivity();
            }, 30000);
        });

        function showSection(section) {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${section}-section`).classList.remove('hidden');
            document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');

            if (section === 'out-list') loadOutStudents();
            if (section === 'logs') loadGateLogs();
            if (section === 'scan') {
                loadDashboardStats();
                loadRecentActivity();
            }
        }

        async function loadDashboardStats() {
            try {
                // Load out students count
                const outRes = await api.getOutStudents();
                if (outRes.success) {
                    document.getElementById('outCount').textContent = outRes.count;
                }

                // Load today's logs
                const today = new Date().toISOString().split('T')[0];
                const logsRes = await api.getGateLogs({ date: today });
                if (logsRes.success) {
                    const exits = logsRes.data.filter(l => l.action === 'EXIT').length;
                    const entries = logsRes.data.filter(l => l.action === 'ENTRY').length;
                    document.getElementById('todayExits').textContent = exits;
                    document.getElementById('todayEntries').textContent = entries;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadRecentActivity() {
            try {
                const res = await api.getGateLogs({});
                if (res.success) {
                    const tbody = document.getElementById('recentActivityTable');
                    const recent = res.data.slice(0, 10);
                    
                    if (recent.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No recent activity</td></tr>';
                        return;
                    }

                    tbody.innerHTML = recent.map(log => `
                        <tr>
                            <td>${utils.formatDateTime(log.timestamp)}</td>
                            <td>${log.studentId?.name || 'Unknown'}</td>
                            <td>
                                <span class="badge badge-${log.action === 'EXIT' ? 'out' : 'in'}">
                                    ${log.action === 'EXIT' ? 'EXIT' : 'ENTRY'}
                                </span>
                            </td>
                            <td><code>${log.gatePassId}</code></td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        async function processGatePass(action) {
            const gatePassId = document.getElementById('gatePassInput').value.trim().toUpperCase();
            const resultDiv = document.getElementById('scanResult');
            
            if (!gatePassId) {
                resultDiv.className = 'message error';
                resultDiv.textContent = 'Please enter a Gate Pass ID';
                return;
            }

            try {
                let res;
                if (action === 'exit') {
                    res = await api.logExit(gatePassId);
                } else {
                    res = await api.logEntry(gatePassId);
                }

                if (res.success) {
                    resultDiv.className = 'message success';
                    resultDiv.innerHTML = `
                        <strong>${action === 'exit' ? 'EXIT' : 'ENTRY'} Recorded!</strong><br>
                        Student: ${res.data.student}<br>
                        ${res.data.isOverstayed ? '<strong style="color: var(--danger-color);">Note: Student has overstayed</strong>' : ''}
                    `;
                    document.getElementById('gatePassInput').value = '';
                    loadDashboardStats();
                    loadRecentActivity();
                } else {
                    resultDiv.className = 'message error';
                    resultDiv.textContent = res.message || 'Operation failed';
                }
            } catch (error) {
                resultDiv.className = 'message error';
                resultDiv.textContent = 'Error processing gate pass';
            }
        }

        async function loadOutStudents() {
            try {
                const res = await api.getOutStudents();
                if (res.success) {
                    document.getElementById('outListCount').textContent = res.count;
                    
                    const tbody = document.getElementById('outStudentsTable');
                    const overstayed = res.data.filter(s => s.isOverstayed);
                    
                    if (res.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No students currently out</td></tr>';
                        document.getElementById('overstayedCard').style.display = 'none';
                        return;
                    }

                    tbody.innerHTML = res.data.map(item => `
                        <tr>
                            <td>${item.student?.name || 'Unknown'}</td>
                            <td>${item.student?.hostelBlock || '-'} / ${item.student?.roomNo || '-'}</td>
                            <td>${item.student?.phone || '-'}</td>
                            <td>${utils.formatDateTime(item.fromDateTime)}</td>
                            <td>${utils.formatDateTime(item.toDateTime)}</td>
                            <td>${item.isOverstayed ? '<span class="badge badge-overstay">OVERSTAYED</span>' : '<span class="badge badge-out">OUT</span>'}</td>
                            <td><code>${item.gatePassId}</code></td>
                        </tr>
                    `).join('');

                    // Show overstayed section
                    if (overstayed.length > 0) {
                        document.getElementById('overstayedCard').style.display = 'block';
                        document.getElementById('overstayedTable').innerHTML = overstayed.map(item => {
                            const now = new Date();
                            const expected = new Date(item.toDateTime);
                            const diffMs = now - expected;
                            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                            
                            return `
                                <tr>
                                    <td>${item.student?.name || 'Unknown'}</td>
                                    <td>${item.student?.phone || '-'}</td>
                                    <td>${utils.formatDateTime(item.toDateTime)}</td>
                                    <td><strong>${diffHours}h ${diffMins}m</strong></td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        document.getElementById('overstayedCard').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading out students:', error);
            }
        }

        async function loadGateLogs() {
            try {
                const date = document.getElementById('logDate').value;
                const action = document.getElementById('logAction').value;
                
                const filters = {};
                if (date) filters.date = date;
                if (action) filters.action = action;

                const res = await api.getGateLogs(filters);
                if (res.success) {
                    const tbody = document.getElementById('gateLogsTable');
                    
                    if (res.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No logs found</td></tr>';
                        return;
                    }

                    tbody.innerHTML = res.data.map(log => `
                        <tr>
                            <td>${utils.formatDateTime(log.timestamp)}</td>
                            <td>${log.studentId?.name || 'Unknown'}</td>
                            <td>${log.studentId?.hostelBlock || '-'} / ${log.studentId?.roomNo || '-'}</td>
                            <td>
                                <span class="badge badge-${log.action === 'EXIT' ? 'out' : 'in'}">
                                    ${log.action}
                                </span>
                            </td>
                            <td><code>${log.gatePassId}</code></td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading gate logs:', error);
            }
        }

        // Handle Enter key on gate pass input
        document.getElementById('gatePassInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                // Default to exit if student is currently IN
                processGatePass('exit');
            }
        });
    </script>
</body>
</html>
